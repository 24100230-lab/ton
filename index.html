<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Th∆∞ Vi·ªán ·∫¢nh Ri√™ng</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Th∆∞ Vi·ªán ·∫¢nh Ri√™ng</h1>
        <p>Up ·∫£nh c·ªßa ng∆∞·ªùi y√™u ‚Äî ch·ªâ l∆∞u tr√™n tr√¨nh duy·ªát c·ªßa b·∫°n (localStorage).</p>
      </div>
      <div class="small">An to√†n & ri√™ng t∆∞ ‚Ä¢ Kh√¥ng g·ª≠i server</div>
    </header>

    <div class="uploader">
      <section class="gallery-card">
        <div class="controls">
          <label class="btn" for="fileInput">Ch·ªçn ·∫£nh</label>
          <input id="fileInput" class="input-file" type="file" accept="image/*" multiple />
          <button id="clearAll" class="btn ghost">X√≥a t·∫•t c·∫£</button>
          <div style="flex:1"></div>
          <button id="downloadAll" class="btn ghost">T·∫£i t·∫•t c·∫£ (m·ªü tab)</button>
        </div>

        <div id="dropzone" class="dropzone">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c nh·∫•n "Ch·ªçn ·∫£nh"</div>
        <div id="thumbGrid" class="thumb-grid" aria-live="polite"></div>
        <div id="emptyState" class="small">Ch∆∞a c√≥ ·∫£nh n√†o ‚Äî up m·ªôt v√†i ·∫£nh ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
      </section>

      <aside class="preview-card">
        <div class="preview-big" id="previewBig"><div class="small">Ch·ªçn m·ªôt ·∫£nh ƒë·ªÉ xem l·ªõn</div></div>
        <div class="small">·∫¢nh ƒë∆∞·ª£c l∆∞u trong b·ªô nh·ªõ tr√¨nh duy·ªát (localStorage). N·∫øu b·∫°n x√≥a cache ho·∫∑c d√πng tr√¨nh duy·ªát kh√°c, ·∫£nh s·∫Ω m·∫•t.</div>
      </aside>
    </div>

    <footer>
      <p class="author">T√°c gi·∫£: <strong>To√†n Nguy·ªÖn</strong></p>
    </footer>
  </div>

  <script>
    const STORAGE_KEY = 'private-photo-gallery-v1';
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const thumbGrid = document.getElementById('thumbGrid');
    const previewBig = document.getElementById('previewBig');
    const emptyState = document.getElementById('emptyState');
    const clearAll = document.getElementById('clearAll');
    const downloadAll = document.getElementById('downloadAll');

    let photos = loadFromStorage();
    render();

    fileInput.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files);
      await handleFiles(files);
      fileInput.value = '';
    });

    ['dragenter','dragover'].forEach(ev=>{
      dropzone.addEventListener(ev,(e)=>{
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
    });
    ['dragleave','drop'].forEach(ev=>{
      dropzone.addEventListener(ev,(e)=>{
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', async (e)=>{
      const files = Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('image/'));
      await handleFiles(files);
    });

    clearAll.addEventListener('click', ()=>{
      if(!confirm('X√≥a t·∫•t c·∫£ ·∫£nh kh·ªèi b·ªô nh·ªõ tr√¨nh duy·ªát?')) return;
      photos = [];
      saveToStorage();
      render();
    });

    downloadAll.addEventListener('click', ()=>{
      if(photos.length===0){alert('Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ t·∫£i.');return}
      photos.forEach(p=>{
        const w = window.open(p.dataUrl,'_blank');
        if(!w) alert('Popup b·ªã ch·∫∑n ‚Äî cho ph√©p popup ƒë·ªÉ t·∫£i nhi·ªÅu ·∫£nh c√πng l√∫c.');
      });
    });

    async function handleFiles(files){
      if(files.length===0) return;
      const maxFileMB = 6;
      for(const f of files){
        if(f.size > maxFileMB*1024*1024){
          alert(`B·ªè qua ${f.name}: l·ªõn h∆°n ${maxFileMB}MB`);
          continue;
        }
        const dataUrl = await fileToDataUrl(f);
        photos.unshift({id:cryptoRandomId(),name:f.name,size:f.size,created:Date.now(),dataUrl});
      }
      saveToStorage();
      render();
    }

    function fileToDataUrl(file){
      return new Promise((res,rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    function render(){
      thumbGrid.innerHTML='';
      emptyState.style.display = photos.length===0 ? 'block' : 'none';
      photos.forEach((p,idx)=>{
        const div = document.createElement('div');
        div.className='thumb';
        div.innerHTML = `
          <img src="${p.dataUrl}" alt="${escapeHtml(p.name)}" />
          <div class="meta">
            <div title="${new Date(p.created).toLocaleString()}">${p.name}</div>
            <div><button class="remove" data-idx="${idx}" title="X√≥a">üóë</button></div>
          </div>`;
        thumbGrid.appendChild(div);
      });

      thumbGrid.querySelectorAll('.thumb img').forEach((img,i)=>{
        img.addEventListener('click', ()=>showPreview(photos[i]));
      });
      thumbGrid.querySelectorAll('.remove').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = Number(btn.getAttribute('data-idx'));
          if(!confirm('X√≥a ·∫£nh n√†y?')) return;
          photos.splice(i,1);
          saveToStorage();
          render();
        });
      });
    }

    function showPreview(item){
      previewBig.innerHTML = '';
      const img = document.createElement('img');
      img.src = item.dataUrl;
      img.alt = item.name;
      previewBig.appendChild(img);
    }

    function saveToStorage(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(photos));
      }catch(e){
        console.error('L∆∞u th·∫•t b·∫°i', e);
        alert('Kh√¥ng th·ªÉ l∆∞u: b·ªô nh·ªõ tr√¨nh duy·ªát ƒë√£ ƒë·∫ßy ho·∫∑c ƒëang ·ªü ch·∫ø ƒë·ªô private.');
      }
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        console.error(e);
        return [];
      }
    }
    function cryptoRandomId(){
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16)
      );
    }
    function escapeHtml(s){
      return s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }
    window.addEventListener('keydown',(e)=>{
      if(e.key.toLowerCase()==='u'){fileInput.click()}
    });
  </script>
</body>
</html>
